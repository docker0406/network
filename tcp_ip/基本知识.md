## 协议的层次与模型
OSI七层模型:  
* 应用层：允许访问OSI环境的手段。HTTP, FTP, DNS, SMTP, Telnet ，（应用协议数据单元APDU）  
* 表示层：对数据进行翻译，加密和压缩。JPEG, MPEG, ASII ，（表示协议数据单元PPDU） 
* 会话层：建立，管理和终止回话。NFS, SQL, RPC ，（会话协议数据单元SPDU）
* 传输层：提供不同端系统的进程间通信，提供端到端的可靠报文传递和错误恢复。TCP, UDP, SPX （段Segment）
* 网络层：提供主机之间的通信，负责数据包从源到宿的传递和网际互连。IP, ICMP, ARP, RAPR, RIP, OSPF, BGP-4 (路由器) （包Packet）
* 数据链路层：提供网络中点到点之间数据帧的传递,将比特组装成帧和点到点的传递。PPP, FR, HDLC, VLAN, MAC (网桥，交换机) （帧Frame）
* 物理层：提供在物理介质上每一比特的传输,通过媒介传输比特,确定机械及电气规范。RJ45, CLOCK, IEEE802.3 (中继器，集线器，网关) （比特Bit）

Internet五层模型:  
* 应用层：将应用程序的报文交给传输层 
* 传输层：将接收的报文分段，封装TCP/UDP头部信息，将报文段传递给网络层 
* 网络层：将接收的报文段封装IP头部信息，将数据报交给数据链路层 
* 数据链路层：将接收网络层的数据报，封装数据帧头部信息，将数据帧从一个节点通过链路传到另一个节点 
* 物理层：数据链路层负责将一个个数据帧从一点传递到另一点，物理层负责一个个比特从一点传递到另一点

## 概述TCP协议
TCP协议是一种点对点的，面向连接的，全双工的服务的，面向字节流的，可靠的，具有拥塞控制的传输层协议 点对点：TCP连接只能是一对一建立的 面向连接：TCP协议在传输数据之前需要建立连接 全双工服务：TCP连接建立之后，连接双方都可以同时向对方发送数据 面向字节流的：TCP把数据看成无结构的，有序的字节流，TCP的序号是建立在字节流上而不是建立在报文段上 可靠的：TCP采用确认重传机制，序号机制，定时器机制，快速重传，滑动窗口机制，流量控制等来保证数据传输的可靠性 拥塞控制：TCP采用慢启动，拥塞避免，快速恢复的机制来进行拥塞控制，共避免网络空间陷入拥塞

TCP报文头部 源端口号：发送方进程端口号 目的端口号：接收方进程端口号 序号：32比特，建立在字节流上的序号机制 确认号：32比特，确认号表示期望收到的下一字节的序号，与序号共同保证TCP的可靠传输 首部长度：TCP首部长度，因为选项字段的存在，一般无选项头部长为20字节 URG：表示报文段中存在被发送方指示为紧急的数据。紧急数据由紧急数据指针指出 ACK：确认标志位，表示首部的确认号有效 PSH：表示接收方应立即将接收的数据交付给上层。因为TCP接收方可能存在接收缓存，接收方可能在忙其他事情，可能等接收缓存满的时候，才会将数据交付给上层，PSH标志位表示接收方应立即将数据交付上层 RST：表示复位，用来异常的关闭连接，引发RST的原因主要有：提前关闭，请求超时，端口未打开，在一个已关闭的SOCKET接收到数据 SYN：建立TCP连接时的标志位 FIN：关闭TCP连接时的标志位 接收窗口：表示接收方还有多少缓存供接收，用于控制发送方的发送速率，以免溢出。用于流量控制 检验和：首部+数据全部的检验和 紧急数据指针：与URG标志位共同使用，指出数据中的紧急数据字段

TCP的可靠数据传输 TCP的可靠数据传输服务保证应用进程从接收缓存中读取的数据是不错，不乱，不丢的数据 确认：只发送ACK确认被正确接收的分组，不发NAK，确认号是期望收到的下一字节 序号：序号基于无结构，有序的字节流。序号表示该报文段的首字节的字节流编号 定时器：TCP设置单一定时器 累计确认：TCP采用累计确认，即接收方发送确认号为x的ACK，表示x之前的报文段都已被正确的接收；但是采用全部重传还是选择重传，TCP没有明确规定 超时重传：如果报文段的传输时间超时，则重传 快熟重传：当发送方收到三个重复ACK（即共4个ACK），则快速重传该报文段

TCP流量控制 因为接收方设置有限的接收缓存，如果发送方发送速率过大的话，接收方缓存可能溢出，导致不必要的分组丢失 所以流量控制是为了限制发送方的发送速率，来保证接收方可以来得及接收到来的报文段 接收方在头部的接收窗口告诉发送方，接收缓存还剩多少，即还能接收多少数据，发送方保证发送的数据量不超过这个量 若接收方告知接收窗口为0了，为避免阻塞，发送方仍发送数据量为1的报文段，接收方接收并回复ACK，并同时告知此时的接收窗口大小 发送方的发送速率由流量控制的接收窗口大小与拥塞控制的拥塞窗口大小共同控制

TCP的拥塞控制 发送方控制自己的发送速率，避免公共网络陷入拥塞，所有TCP发送方共同维护公共网络 拥塞控制与流量控制的区别：流量控制是考虑端到端之间的问题，是避免发送方发送速率过快导致接收方来不及接收，考虑的是私人利益；拥塞控制考虑的是公共网络，避免发送方发送速率过快而导致网络陷入拥塞，考虑的是公共网络的问题 TCP在发送方维护一个CWND的拥塞窗口变量，与接收窗口RWND共同控制发送速率（滑动窗口的大小） TCP根据丢包事件来感知网络的拥塞状态，如果发生超时丢包事件，则说明网络已经比较拥塞了，数据已经传输不到接收方；如果重复ACK丢包事件，则表示网络可能即将陷入拥塞，但是没有那么严重，因为数据还能传输到接收方 拥塞控制方法 慢启动：TCP启动速度很慢，一般从MSS从1开始，但是希望快速找到可用带宽的数量，发送速率指数增长，知道遇到丢包时间，则设置一个阀值等于丢包时的速率的一般，即ssthresh = CWND/2 拥塞避免：如果是超时事件引起的丢包，则进入拥塞避免状态，拥塞避免状态将阀值设为拥塞窗口值的一半之后，将速率设为MSS = 1，然后开始指数增长，直到达到阀值ssthresh，此时可能即将进入拥塞状态了，所以之后再线性增长，直到遇到丢包事件 快速恢复：如果是3个重复ACK引起的丢包事件，此时TCP执行快速重传，并进入快速恢复状态，将阀值设为拥塞窗口值的一般，即ssthresh = CWND/2，然后将发送速率降为阀值ssthresh，之后线性增长，直到遇到丢包事件

## TCP和UDP的区别
1. TCP面向连接（如打电话要先拨号建立连接）;UDP是无连接的，即发送数据之前不需要建立连接
2. TCP提供可靠的服务。也就是说，通过TCP连接传送的数据，无差错，不丢失，不重复，且按序到达; UDP尽最大努力交付，即不保证可靠交付
3. TCP面向字节流，实际上是TCP把数据看成一连串无结构的字节流;UDP是面向报文的, 
4. UDP没有拥塞控制，因此网络出现拥塞不会使源主机的发送速率降低
5. 每一条TCP连接只能是点到点的;UDP支持一对一，一对多，多对一和多对多的交互通信
6. TCP首部开销20字节;UDP的首部开销小，只有8个字节
7. TCP的逻辑通信信道是全双工的可靠信道，UDP则是不可靠信道

## TCP滑动窗口
  滑动窗口协议是用来改善吞吐量的一种技术，即容许发送方在接收任何应答之前传送附加的包。接收方告诉发送方在某一时刻能送多少包(称窗口尺寸)。

  TCP中采用滑动窗口来进行传输控制，滑动窗口的大小意味着接收方还有多大的缓冲区可以用于接收数据。发送方可以通过滑动窗口的大小来确定应该发送多少字节的数据。当滑动窗口为0时，发送方一般不能再发送数据报，但有两种情况除外，一种情况是可以发送紧急数据，例如，允许用户终止在远端机上的运行进程。另一种情况是发送方可以发送一个1字节的数据报来通知接收方重新声明它希望接收的下一字节及发送方的滑动窗口大小。

  滑动窗口机制为端到端设备间的数据传输提供了可靠的流量控制机制。然而，它只能在源端设备和目的端设备起作用，当网络中间设备(例如路由器等)发生拥塞时，滑动窗口机制将不起作用。

## TCP拥塞控制
在计算机网络中的链路容量(即带宽)、交换节点中的缓存和处理机等，都是网络中的资源。在某段时间，若对网络中某一资源的需求超过了该资源所能提供的可用部分，网络的性能就会变坏。这种情况就叫做 拥塞。

拥塞控制 就是 防止过多的数据注入网络中，这样可以使网络中的路由器或链路不致过载。

拥塞控制是一个全局性的过程，和流量控制不同，流量控制指点对点通信量的控制。

进行拥塞控制的四种算法：

1. 慢开始（Slow-start)
2. 拥塞避免（Congestion Avoidance)
3. 快重传（Fast Restrangsmit)
4. 快恢复（Fast Recovery）。

### 慢开始和拥塞避免
发送方维持一个叫做拥塞窗口cwnd（congestion window）的状态变量。拥塞窗口的大小取决于网络的拥塞程度，并且动态地在变化。发送方让自己的发送窗口等于拥塞窗口，另外考虑到接受方的接收能力，发送窗口可能小于拥塞窗口。

慢开始算法的思路就是，不要一开始就发送大量的数据，先探测一下网络的拥塞程度，也就是说由小到大逐渐增加拥塞窗口的大小。在一开始发送方先设置cwnd=1，每经过一次传输轮次之后拥塞窗口就加倍（2的指数倍增加）。

为了防止窗口cwnd增长过大引起网络拥塞，还需设置一个慢开始门限ssthresh状态变量。ssthresh的用法如下：

当cwnd<ssthresh时，使用慢开始算法。
当cwnd>ssthresh时，改用拥塞避免算法。
当cwnd=ssthresh时，既可使用慢开始算法，也可使用拥塞算法。
拥塞避免算法让拥塞窗口缓慢增长，即每经过一个往返时间RTT就把发送方的拥塞窗口cwnd加1，而不是加倍。这样拥塞窗口按线性规律缓慢增长，比慢开始算法的拥塞窗口增长速率缓慢得多。

无论是在慢开始阶段还是在拥塞避免阶段，只要发送方判断网络出现拥塞（其根据就是没有收到确认，虽然没有收到确认可能是其他原因的分组丢失，但是因为无法判定，所以都当做拥塞来处理），就把慢开始门限设置为出现拥塞时的发送窗口大小的一半。然后把拥塞窗口设置为1，执行慢开始算法。


### 快重传和快恢复
快重传要求接收方在收到一个失序的报文段后就立即发出重复确认（为的是使发送方及早知道有报文段没有到达对方）而不要等到自己发送数据时捎带确认。快重传算法规定，发送方只要一连收到三个重复确认就应当立即重传对方尚未收到的报文段，而不必继续等待设置的重传计时器时间到期。由于发送方能 尽早重传未被确认的报文段，因此采用快重传算法后可以使整个网络的吞吐量提高约20%。

快恢复算法，有以下两个要点:

1. 当发送方连续收到三个重复确认时，就执行“乘法减小”算法，把ssthresh门限减半。但是接下去并不执行慢开始算法。
2. 考虑到如果网络出现拥塞的话就不会收到好几个重复的确认，所以发送方现在认为网络可能没有出现拥塞。所以此时不执行慢开始算法，而是将cwnd设置为ssthresh的大小，然后执行拥塞避免算法。
